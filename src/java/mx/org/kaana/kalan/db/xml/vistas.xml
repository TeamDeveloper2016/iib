<?xml version="1.0" encoding="ISO-8859-1"?>
<!--
		Relación de consultas para las vistas de IMOX
-->
<process>
	<dml> 
		<unit id="VistaCuentasDto">
      <select id="lazy">
select      
  tc_kalan_cuentas_movimientos.id_cuenta_movimiento as id_key,     
  tc_kalan_cuentas_movimientos.id_cuenta_movimiento,
  tc_kalan_cuentas_movimientos.id_empresa_destino,
  tc_kalan_cuentas_origenes.id_cuenta_origen,
  tc_mantic_empresas.nombre as empresa,
  tc_kalan_empresas_cuentas.cuenta as clave,
  tc_kalan_empresas_cuentas.nombre as cuenta,
  tc_kalan_cuentas_movimientos.consecutivo,
  ifnull(tt_kalan_cuentas_movimientos.consecutivo, '') as ligado,
  tc_kalan_cuentas_movimientos.fecha_aplicacion,
  tc_kalan_cuentas_movimientos.fecha_pago,
  tc_kalan_cuentas_movimientos.importe,
  tc_mantic_tipos_medios_pagos.nombre as medio,
  tc_kalan_cuentas_movimientos.id_cuenta_estatus,
  tc_kalan_cuentas_estatus.nombre as estatus,
  tc_kalan_cuentas_estatus.estatus_asociados,
  tc_kalan_tipos_afectaciones.nombre as tipo,
  tc_kalan_cuentas_origenes.clave as codigo,
  tc_kalan_cuentas_origenes.nombre as origen,
  concat(tc_mantic_personas.nombres, ' ', tc_mantic_personas.paterno, ' ', ifnull(tc_mantic_personas.materno, '')) as usuario,
  tc_kalan_cuentas_movimientos.observaciones,
  tc_kalan_cuentas_movimientos.registro
from      
  tc_kalan_cuentas_movimientos
left join
  tc_kalan_cuentas_movimientos as tt_kalan_cuentas_movimientos on tc_kalan_cuentas_movimientos.id_empresa_destino= tt_kalan_cuentas_movimientos.id_cuenta_movimiento
inner join
  tc_mantic_empresas on tc_kalan_cuentas_movimientos.id_empresa= tc_mantic_empresas.id_empresa
inner join
  tc_kalan_empresas_cuentas on tc_kalan_cuentas_movimientos.id_empresa_cuenta= tc_kalan_empresas_cuentas.id_empresa_cuenta
inner join
  tc_mantic_tipos_medios_pagos on tc_kalan_cuentas_movimientos.id_tipo_medio_pago= tc_mantic_tipos_medios_pagos.id_tipo_medio_pago
inner join    
  tc_kalan_tipos_afectaciones on tc_kalan_cuentas_movimientos.id_tipo_afectacion= tc_kalan_tipos_afectaciones.id_tipo_afectacion
inner join    
  tc_kalan_cuentas_estatus on tc_kalan_cuentas_movimientos.id_cuenta_estatus= tc_kalan_cuentas_estatus.id_cuenta_estatus
inner join    
  tc_kalan_cuentas_origenes on tc_kalan_cuentas_movimientos.id_cuenta_origen= tc_kalan_cuentas_origenes.id_cuenta_origen
inner join
	tc_janal_usuarios on tc_kalan_cuentas_movimientos.id_usuario= tc_janal_usuarios.id_usuario
inner join
	tc_mantic_personas on tc_janal_usuarios.id_persona= tc_mantic_personas.id_persona
where
  tc_mantic_empresas.id_empresa in ({idEmpresa})    
  and {condicion}        
{sortOrder}
      </select>  
      <select id="totales">
select      
  tc_kalan_cuentas_movimientos.id_cuenta_movimiento as id_key,     
  ifnull(sum(if(tc_kalan_cuentas_movimientos.id_tipo_afectacion= 1, tc_kalan_cuentas_movimientos.importe, 0)), 0) as cargos,      
  ifnull(sum(if(tc_kalan_cuentas_movimientos.id_tipo_afectacion= 2, tc_kalan_cuentas_movimientos.importe, 0)), 0) as abonos,      
  ifnull(sum(if(tc_kalan_cuentas_movimientos.id_tipo_afectacion= 2, tc_kalan_cuentas_movimientos.importe, -1* tc_kalan_cuentas_movimientos.importe)), 0) as saldo     
from      
  tc_kalan_cuentas_movimientos
inner join
  tc_mantic_empresas on tc_kalan_cuentas_movimientos.id_empresa= tc_mantic_empresas.id_empresa
inner join
  tc_kalan_empresas_cuentas on tc_kalan_cuentas_movimientos.id_empresa_cuenta= tc_kalan_empresas_cuentas.id_empresa_cuenta
inner join
  tc_mantic_tipos_medios_pagos on tc_kalan_cuentas_movimientos.id_tipo_medio_pago= tc_mantic_tipos_medios_pagos.id_tipo_medio_pago
inner join    
  tc_kalan_tipos_afectaciones on tc_kalan_cuentas_movimientos.id_tipo_afectacion= tc_kalan_tipos_afectaciones.id_tipo_afectacion
inner join    
  tc_kalan_cuentas_estatus on tc_kalan_cuentas_movimientos.id_cuenta_estatus= tc_kalan_cuentas_estatus.id_cuenta_estatus
inner join    
  tc_kalan_cuentas_origenes on tc_kalan_cuentas_movimientos.id_cuenta_origen= tc_kalan_cuentas_origenes.id_cuenta_origen
inner join
	tc_janal_usuarios on tc_kalan_cuentas_movimientos.id_usuario= tc_janal_usuarios.id_usuario
inner join
	tc_mantic_personas on tc_janal_usuarios.id_persona= tc_mantic_personas.id_persona
where
  tc_mantic_empresas.id_empresa in ({idEmpresa})    
  and {condicion}        
{sortOrder}
      </select>  
			<select id="movimientos">
select
  tc_kalan_cuentas_bitacora.id_cuenta_bitacora as id_key,
  tc_kalan_cuentas_movimientos.consecutivo,
  0 as importe,
  tc_kalan_cuentas_bitacora.justificacion,
  concat(tc_mantic_personas.nombres, ' ', tc_mantic_personas.paterno, ' ', tc_mantic_personas.materno) as nombre,
  tc_kalan_cuentas_estatus.nombre as estatus,
  tc_kalan_cuentas_bitacora.registro
from 
  tc_kalan_cuentas_bitacora
inner join
  tc_kalan_cuentas_movimientos on tc_kalan_cuentas_bitacora.id_cuenta_movimiento= tc_kalan_cuentas_movimientos.id_cuenta_movimiento
inner join
  tc_kalan_cuentas_estatus on tc_kalan_cuentas_bitacora.id_cuenta_estatus= tc_kalan_cuentas_estatus.id_cuenta_estatus
inner join
  tc_janal_usuarios on tc_kalan_cuentas_bitacora.id_usuario= tc_janal_usuarios.id_usuario
inner join
  tc_mantic_personas on tc_janal_usuarios.id_persona= tc_mantic_personas.id_persona
where
  tc_kalan_cuentas_movimientos.id_cuenta_movimiento= {idCuentaMovimiento}
order by
  tc_kalan_cuentas_movimientos.registro desc
			</select>		
    </unit>  
		<unit id="VistaAhorrosDto">
      <select id="lazy">
select 
  tc_kalan_ahorros.id_ahorro as id_key,
  tc_kalan_ahorros.id_ahorro,
  tc_kalan_ahorros.id_ahorro_estatus,
  tc_mantic_empresas.nombre as empresa,
  tc_kalan_ahorros.consecutivo,
  tr_mantic_empresa_personal.clave,
  tc_mantic_personas.rfc,
  tc_mantic_personas.curp,
  concat(tc_mantic_personas.nombres, ' ', ifnull(tc_mantic_personas.paterno, ''), ' ', ifnull(tc_mantic_personas.materno, '')) as empleado,
  tc_kalan_ahorros.nombre,
  tc_kalan_ahorros.inicia,
  tc_kalan_ahorros.inicia as inicio,
  tc_kalan_ahorros_estatus.nombre as estatus,
  tc_kalan_ahorros_estatus.estatus_asociados,
  ifnull(tt_kalan_ahorros.pagado, 0) as pagado,
  ifnull(tt_kalan_ahorros.ahorrado, 0) as ahorrado,
  tc_kalan_ahorros.inicia+ ifnull(tt_kalan_ahorros.ahorrado, 0)- ifnull(tt_kalan_ahorros.pagado, 0) as total,
  tc_kalan_ahorros.fecha_aplicacion
from   
  tc_kalan_ahorros
inner join  
  tr_mantic_empresa_personal on tc_kalan_ahorros.id_empresa_persona= tr_mantic_empresa_personal.id_empresa_persona
inner join
  tc_mantic_personas on tr_mantic_empresa_personal.id_persona= tc_mantic_personas.id_persona
inner join
  tc_mantic_empresas on tr_mantic_empresa_personal.id_empresa= tc_mantic_empresas.id_empresa
inner join
  tc_kalan_ahorros_estatus on tc_kalan_ahorros.id_ahorro_estatus= tc_kalan_ahorros_estatus.id_ahorro_estatus
left join (
	select
	  tc_kalan_ahorros.id_ahorro,
		tc_kalan_ahorros.id_empresa_persona,
		sum(if(tc_kalan_ahorros_pagos.id_tipo_afectacion= 1, tc_kalan_ahorros_pagos.importe, 0)) as pagado,
		sum(if(tc_kalan_ahorros_pagos.id_tipo_afectacion= 2, tc_kalan_ahorros_pagos.importe, 0)) as ahorrado
	from
		tc_kalan_ahorros
	inner join
	  tc_kalan_ahorros_pagos on tc_kalan_ahorros.id_ahorro= tc_kalan_ahorros_pagos.id_ahorro
	where
		tc_kalan_ahorros_pagos.id_ahorro_control in (2, 4)
	group by   
		tc_kalan_ahorros.id_ahorro, 
		tc_kalan_ahorros.id_empresa_persona        
) as tt_kalan_ahorros on tr_mantic_empresa_personal.id_empresa_persona= tt_kalan_ahorros.id_empresa_persona and tc_kalan_ahorros.id_ahorro= tt_kalan_ahorros.id_ahorro
where
  tr_mantic_empresa_personal.id_empresa in ({idEmpresa})    
  and {condicion}        
{sortOrder}
      </select>
      <select id="general">
select 
  ifnull(tc_kalan_ahorros.id_ahorro, -1) as id_key,
  ifnull(sum(tc_kalan_ahorros.inicia), 0) as inicia,
  ifnull(sum(tt_kalan_ahorros.ahorrado), 0) as ahorrado,
  ifnull(sum(tt_kalan_ahorros.pagado), 0) as pagado,
from   
  tc_kalan_ahorros
inner join  
  tr_mantic_empresa_personal on tc_kalan_ahorros.id_empresa_persona= tr_mantic_empresa_personal.id_empresa_persona
inner join
  tc_mantic_personas on tr_mantic_empresa_personal.id_persona= tc_mantic_personas.id_persona
inner join
  tc_mantic_empresas on tr_mantic_empresa_personal.id_empresa= tc_mantic_empresas.id_empresa
inner join
  tc_kalan_ahorros_estatus on tc_kalan_ahorros.id_ahorro_estatus= tc_kalan_ahorros_estatus.id_ahorro_estatus
inner join (
	select
	  tc_kalan_ahorros.id_ahorro,
		tc_kalan_ahorros.id_empresa_persona,
		sum(if(tc_kalan_ahorros_pagos.id_tipo_afectacion= 1, tc_kalan_ahorros_pagos.importe, 0)) as pagado,
		sum(if(tc_kalan_ahorros_pagos.id_tipo_afectacion= 2, tc_kalan_ahorros_pagos.importe, 0)) as ahorrado
	from
		tc_kalan_ahorros
	inner join
	  tc_kalan_ahorros_pagos on tc_kalan_ahorros.id_ahorro= tc_kalan_ahorros_pagos.id_ahorro
	where
		tc_kalan_ahorros_pagos.id_ahorro_control in (2, 4)
	group by   
		tc_kalan_ahorros.id_ahorro, 
		tc_kalan_ahorros.id_empresa_persona        
) as tt_kalan_ahorros on tr_mantic_empresa_personal.id_empresa_persona= tt_kalan_ahorros.id_empresa_persona and tc_kalan_ahorros.id_ahorro= tt_kalan_ahorros.id_ahorro
where
  tr_mantic_empresa_personal.id_empresa in ({idEmpresa})    
  and {condicion}        
      </select>  
      <select id="pagos">
select 
  tc_kalan_ahorros_pagos.id_ahorro_pago as id_key,
  tc_kalan_ahorros_pagos.id_ahorro,
  tc_kalan_ahorros_pagos.id_ahorro_pago,
  tc_kalan_ahorros_pagos.consecutivo,
  tc_mantic_tipos_medios_pagos.nombre as medio,        
  tc_kalan_ahorros_pagos.importe,
  tc_kalan_ahorros_pagos.observaciones,
  tc_kalan_ahorros_pagos.id_tipo_afectacion,
  tc_kalan_ahorros_controles.nombre as estatus,
  tc_kalan_tipos_afectaciones.nombre as afectacion,
  concat(tc_mantic_personas.nombres, ' ', tc_mantic_personas.paterno, ' ', ifnull(tc_mantic_personas.materno, '')) as usuario,
  tc_kalan_ahorros_pagos.fecha_aplicacion
from   
  tc_kalan_ahorros_pagos
inner join
  tc_mantic_tipos_medios_pagos on tc_kalan_ahorros_pagos.id_tipo_medio_pago= tc_mantic_tipos_medios_pagos.id_tipo_medio_pago
inner join
  tc_kalan_tipos_afectaciones on tc_kalan_ahorros_pagos.id_tipo_afectacion= tc_kalan_tipos_afectaciones.id_tipo_afectacion
inner join
  tc_kalan_ahorros_controles on tc_kalan_ahorros_pagos.id_ahorro_control= tc_kalan_ahorros_controles.id_ahorro_control
  inner join
    tc_janal_usuarios on tc_kalan_ahorros_pagos.id_usuario= tc_janal_usuarios.id_usuario
  inner join
    tc_mantic_personas on tc_janal_usuarios.id_persona= tc_mantic_personas.id_persona
where
  tc_kalan_ahorros_pagos.id_ahorro_control in (2, 4)
  and tc_kalan_ahorros_pagos.id_ahorro= {idAhorro}
{sortOrder}        
      </select>  
			<select id="movimientos">
select
  tc_kalan_ahorros_bitacora.id_ahorro_bitacora as id_key,
  tc_kalan_ahorros.consecutivo,
  0 as importe,
  tc_kalan_ahorros_bitacora.justificacion,
  concat(tc_mantic_personas.nombres, ' ', tc_mantic_personas.paterno, ' ', tc_mantic_personas.materno) as nombre,
  tc_kalan_ahorros_estatus.nombre as estatus,
  tc_kalan_ahorros_bitacora.registro
from 
  tc_kalan_ahorros_bitacora
inner join
  tc_kalan_ahorros on tc_kalan_ahorros_bitacora.id_ahorro= tc_kalan_ahorros.id_ahorro
inner join
  tc_kalan_ahorros_estatus on tc_kalan_ahorros_bitacora.id_ahorro_estatus= tc_kalan_ahorros_estatus.id_ahorro_estatus
inner join
  tc_janal_usuarios on tc_kalan_ahorros_bitacora.id_usuario= tc_janal_usuarios.id_usuario
inner join
  tc_mantic_personas on tc_janal_usuarios.id_persona= tc_mantic_personas.id_persona
where
  tc_kalan_ahorros.id_ahorro= {idAhorro}
order by
  tc_kalan_ahorros.registro desc				
			</select>		
    </unit>  
		<unit id="VistaPrestamosDto">
			<select id="disponible">			
select
  tc_kalan_prestamos.id_empresa_persona as id_key,
  tc_kalan_prestamos.id_empresa_persona,
  tr_mantic_empresa_personal.limite,
  ifnull(count(distinct(tc_kalan_prestamos.id_prestamo)), 0) as cantidad,
  ifnull(sum(tc_kalan_prestamos.importe), 0) as prestamos,
  ifnull(tt_kalan_prestamos_pagos.abonado, 0) as abonado,
  ifnull(sum(tc_kalan_prestamos.importe)- ifnull(tt_kalan_prestamos_pagos.abonado, 0), 0) as saldo,
  ifnull(tr_mantic_empresa_personal.limite- sum(tc_kalan_prestamos.importe)+ ifnull(tt_kalan_prestamos_pagos.abonado, 0), 0) as disponible 
from
  tc_kalan_prestamos
inner join
  tr_mantic_empresa_personal on tc_kalan_prestamos.id_empresa_persona= tr_mantic_empresa_personal.id_empresa_persona
left join (
  select
    tc_kalan_prestamos_pagos.id_prestamo,
    ifnull(sum(if(tc_kalan_prestamos_pagos.id_tipo_afectacion= 2, tc_kalan_prestamos_pagos.importe, -1* tc_kalan_prestamos_pagos.importe)), 0) as abonado
  from
    tc_kalan_prestamos_pagos
  where
    tc_kalan_prestamos_pagos.id_prestamo!= {idPrestamo}
  group by  
    tc_kalan_prestamos_pagos.id_prestamo
) as tt_kalan_prestamos_pagos on tc_kalan_prestamos.id_prestamo= tt_kalan_prestamos_pagos.id_prestamo
where
  tc_kalan_prestamos.id_prestamo_estatus in (1, 2, 6) 
  and tc_kalan_prestamos.id_empresa_persona= {idEmpresaPersona}
  and tc_kalan_prestamos.id_prestamo!= {idPrestamo}
group by   
  tc_kalan_prestamos.id_empresa_persona
      </select>  
			<select id="porCodigo">			
select      
  tr_mantic_empresa_personal.id_empresa_persona as id_key,
  tc_mantic_personas.id_persona,
  tr_mantic_empresa_personal.clave,
  tc_mantic_personas.rfc,
  tc_mantic_personas.curp,
  concat(tc_mantic_personas.nombres, ' ', ifnull(tc_mantic_personas.paterno, ''), ' ', ifnull(tc_mantic_personas.materno, '')) as nombre
from      
  tr_mantic_empresa_personal
inner join
  tc_mantic_personas on tr_mantic_empresa_personal.id_persona= tc_mantic_personas.id_persona
where 
  tr_mantic_empresa_personal.id_empresa in ({sucursales})
  and upper(tr_mantic_empresa_personal.clave) regexp '.*{codigo}.*'
  and tr_mantic_empresa_personal.id_empresa_persona&gt; 2
order by
  tr_mantic_empresa_personal.clave
			</select>
			<select id="porNombre">			
select      
  tr_mantic_empresa_personal.id_empresa_persona as id_key,
  tc_mantic_personas.id_persona,
  tr_mantic_empresa_personal.clave,
  tc_mantic_personas.rfc,
  tc_mantic_personas.curp,
  concat(tc_mantic_personas.nombres, ' ', ifnull(tc_mantic_personas.paterno, ''), ' ', ifnull(tc_mantic_personas.materno, '')) as nombre
from      
  tr_mantic_empresa_personal
inner join
  tc_mantic_personas on tr_mantic_empresa_personal.id_persona= tc_mantic_personas.id_persona
where 
  tr_mantic_empresa_personal.id_empresa in ({sucursales})
  and upper(concat(tc_mantic_personas.nombres, ' ', ifnull(tc_mantic_personas.paterno, ''), ' ', ifnull(tc_mantic_personas.materno, ''))) regexp '.*{codigo}.*'
  and tr_mantic_empresa_personal.id_empresa_persona&gt; 2
order by
  concat(tc_mantic_personas.nombres, ' ', ifnull(tc_mantic_personas.paterno, ''), ' ', ifnull(tc_mantic_personas.materno, ''))
			</select>
			<select id="empleados">			
select      
  tr_mantic_empresa_personal.id_empresa_persona as id_key,
  tr_mantic_empresa_personal.clave,
  tc_mantic_personas.rfc,
  tc_mantic_personas.curp,
  concat(tc_mantic_personas.nombres, ' ', ifnull(tc_mantic_personas.paterno, ''), ' ', ifnull(tc_mantic_personas.materno, '')) as nombre
from      
  tr_mantic_empresa_personal
inner join
  tc_mantic_personas on tr_mantic_empresa_personal.id_persona= tc_mantic_personas.id_persona
where 
  tr_mantic_empresa_personal.id_empresa in ({sucursales})
  and tr_mantic_empresa_personal.id_empresa_persona&gt; 2
  and {condicion}
order by
  concat(tc_mantic_personas.nombres, ' ', ifnull(tc_mantic_personas.paterno, ''), ' ', ifnull(tc_mantic_personas.materno, ''))
			</select>
      <select id="lazy">
select 
  tc_kalan_prestamos.id_prestamo as id_key,
  tc_kalan_prestamos.id_prestamo,
  tc_kalan_prestamos.id_prestamo_estatus,
  tc_mantic_empresas.nombre as empresa,
  tc_kalan_prestamos.consecutivo,
  tr_mantic_empresa_personal.clave,
  tc_mantic_personas.rfc,
  tc_mantic_personas.curp,
  concat(tc_mantic_personas.nombres, ' ', ifnull(tc_mantic_personas.paterno, ''), ' ', ifnull(tc_mantic_personas.materno, '')) as empleado,
  tc_kalan_prestamos.nombre,
  tc_kalan_prestamos.importe,
  tc_kalan_prestamos.saldo,
  tc_kalan_prestamos_estatus.nombre as estatus,
  tc_kalan_prestamos_estatus.estatus_asociados,
  ifnull(tt_kalan_prestamos.disponible, tr_mantic_empresa_personal.limite) as disponible,        
  tc_kalan_prestamos.fecha_aplicacion
from   
  tc_kalan_prestamos
inner join  
  tr_mantic_empresa_personal on tc_kalan_prestamos.id_empresa_persona= tr_mantic_empresa_personal.id_empresa_persona
inner join
  tc_mantic_personas on tr_mantic_empresa_personal.id_persona= tc_mantic_personas.id_persona
inner join
  tc_mantic_empresas on tr_mantic_empresa_personal.id_empresa= tc_mantic_empresas.id_empresa
inner join
  tc_kalan_prestamos_estatus on tc_kalan_prestamos.id_prestamo_estatus= tc_kalan_prestamos_estatus.id_prestamo_estatus
left join (
	select
		tc_kalan_prestamos.id_empresa_persona,
		tr_mantic_empresa_personal.limite- sum(tc_kalan_prestamos.saldo) as disponible
	from
		tc_kalan_prestamos
	inner join
		tr_mantic_empresa_personal on tc_kalan_prestamos.id_empresa_persona= tr_mantic_empresa_personal.id_empresa_persona
	where
		tc_kalan_prestamos.id_prestamo_estatus in (1, 2, 6) 
	group by   
		tc_kalan_prestamos.id_empresa_persona
) as tt_kalan_prestamos on tr_mantic_empresa_personal.id_empresa_persona= tt_kalan_prestamos.id_empresa_persona
where
  tr_mantic_empresa_personal.id_empresa in ({idEmpresa})    
  and {condicion}        
{sortOrder}
      </select>  
      <select id="general">
select 
  ifnull(tc_kalan_prestamos.id_prestamo, -1) as id_key,
  ifnull(sum(tc_kalan_prestamos.importe), 0) as total,
  ifnull(sum(tc_kalan_prestamos.saldo), 0) as saldo
from   
  tc_kalan_prestamos
inner join  
  tr_mantic_empresa_personal on tc_kalan_prestamos.id_empresa_persona= tr_mantic_empresa_personal.id_empresa_persona
inner join
  tc_mantic_personas on tr_mantic_empresa_personal.id_persona= tc_mantic_personas.id_persona
inner join
  tc_mantic_empresas on tr_mantic_empresa_personal.id_empresa= tc_mantic_empresas.id_empresa
inner join
  tc_kalan_prestamos_estatus on tc_kalan_prestamos.id_prestamo_estatus= tc_kalan_prestamos_estatus.id_prestamo_estatus
where
  tr_mantic_empresa_personal.id_empresa in ({idEmpresa})    
  and {condicion}        
      </select>  
      <select id="pagos">
select 
  tc_kalan_prestamos_pagos.id_prestamo_pago as id_key,
  tc_kalan_prestamos_pagos.id_prestamo,
  tc_kalan_prestamos_pagos.id_prestamo_pago,
  tc_kalan_prestamos_pagos.consecutivo,
  tc_mantic_tipos_medios_pagos.nombre as medio,        
  tc_kalan_prestamos_pagos.importe,
  tc_kalan_prestamos_pagos.observaciones,
  tc_kalan_prestamos_pagos.id_tipo_afectacion,
  tc_kalan_tipos_afectaciones.nombre as afectacion,
  concat(tc_mantic_personas.nombres, ' ', tc_mantic_personas.paterno, ' ', ifnull(tc_mantic_personas.materno, '')) as usuario,
  tc_kalan_prestamos_pagos.fecha_aplicacion
from   
  tc_kalan_prestamos_pagos
inner join
  tc_mantic_tipos_medios_pagos on tc_kalan_prestamos_pagos.id_tipo_medio_pago= tc_mantic_tipos_medios_pagos.id_tipo_medio_pago
inner join
  tc_kalan_tipos_afectaciones on tc_kalan_prestamos_pagos.id_tipo_afectacion= tc_kalan_tipos_afectaciones.id_tipo_afectacion
inner join
	tc_janal_usuarios on tc_kalan_prestamos_pagos.id_usuario= tc_janal_usuarios.id_usuario
inner join
	tc_mantic_personas on tc_janal_usuarios.id_persona= tc_mantic_personas.id_persona
where
  tc_kalan_prestamos_pagos.id_prestamo= {idPrestamo}
{sortOrder}        
      </select>  
			<select id="movimientos">
select
  tc_kalan_prestamos_bitacora.id_prestamo_bitacora as id_key,
  tc_kalan_prestamos.consecutivo,
  0 as importe,
  tc_kalan_prestamos_bitacora.justificacion,
  concat(tc_mantic_personas.nombres, ' ', tc_mantic_personas.paterno, ' ', tc_mantic_personas.materno) as nombre,
  tc_kalan_prestamos_estatus.nombre as estatus,
  tc_kalan_prestamos_bitacora.registro
from 
  tc_kalan_prestamos_bitacora
inner join
  tc_kalan_prestamos on tc_kalan_prestamos_bitacora.id_prestamo= tc_kalan_prestamos.id_prestamo
inner join
  tc_kalan_prestamos_estatus on tc_kalan_prestamos_bitacora.id_prestamo_estatus= tc_kalan_prestamos_estatus.id_prestamo_estatus
inner join
  tc_janal_usuarios on tc_kalan_prestamos_bitacora.id_usuario= tc_janal_usuarios.id_usuario
inner join
  tc_mantic_personas on tc_janal_usuarios.id_persona= tc_mantic_personas.id_persona
where
  tc_kalan_prestamos.id_prestamo= {idPrestamo}
order by
  tc_kalan_prestamos.registro desc				
			</select>		
    </unit>  
		<unit id="VistaCreditosDto">
      <select id="lazy">
select 
  tc_kalan_creditos.id_credito as id_key,
  tc_kalan_creditos.id_credito,
  tc_kalan_creditos.id_credito_estatus,
  tc_mantic_empresas.nombre as empresa,
  tc_kalan_creditos.consecutivo,
  tc_mantic_acreedores.clave,
  tc_mantic_acreedores.rfc,
  tc_mantic_acreedores.razon_social,
  tc_kalan_creditos.nombre,
  tc_kalan_creditos.importe,
  tc_kalan_creditos.saldo,
  tc_kalan_creditos_estatus.nombre as estatus,
  tc_kalan_creditos_estatus.estatus_asociados,
  tc_kalan_creditos.fecha_aplicacion
from   
  tc_kalan_creditos
inner join
  tc_mantic_empresas on tc_kalan_creditos.id_empresa= tc_mantic_empresas.id_empresa
inner join
  tc_mantic_acreedores on tc_kalan_creditos.id_acreedor= tc_mantic_acreedores.id_acreedor
inner join
  tc_kalan_creditos_estatus on tc_kalan_creditos.id_credito_estatus= tc_kalan_creditos_estatus.id_credito_estatus
where
  tc_kalan_creditos.id_empresa in ({idEmpresa})    
  and {condicion}        
{sortOrder}
      </select>  
      <select id="general">
select 
  tc_kalan_creditos.id_credito as id_key,
  ifnull(sum(tc_kalan_creditos.importe), 0) as total,
  ifnull(sum(tc_kalan_creditos.saldo), 0) as saldo
from   
  tc_kalan_creditos
inner join
  tc_mantic_acreedores on tc_kalan_creditos.id_acreedor= tc_mantic_acreedores.id_acreedor
inner join
  tc_kalan_creditos_estatus on tc_kalan_creditos.id_credito_estatus= tc_kalan_creditos_estatus.id_credito_estatus
where
  tc_kalan_creditos.id_empresa in ({idEmpresa})
  and {condicion}        
      </select>  
      <select id="pagos">
select 
  tc_kalan_creditos_pagos.id_credito_pago as id_key,
  tc_kalan_creditos_pagos.id_credito_pago,
  tc_kalan_creditos_pagos.id_credito,
  tc_kalan_creditos_pagos.consecutivo,
  tc_mantic_tipos_medios_pagos.nombre as medio,
  tc_kalan_creditos_pagos.importe,
  tc_kalan_creditos_pagos.observaciones,
  tc_kalan_creditos_pagos.id_tipo_afectacion,
  tc_kalan_tipos_afectaciones.nombre as afectacion,
  concat(tc_mantic_personas.nombres, ' ', tc_mantic_personas.paterno, ' ', ifnull(tc_mantic_personas.materno, '')) as usuario,
  tc_kalan_creditos_pagos.fecha_aplicacion
from   
  tc_kalan_creditos_pagos
inner join
  tc_mantic_tipos_medios_pagos on tc_kalan_creditos_pagos.id_tipo_medio_pago= tc_mantic_tipos_medios_pagos.id_tipo_medio_pago
inner join
  tc_kalan_tipos_afectaciones on tc_kalan_creditos_pagos.id_tipo_afectacion= tc_kalan_tipos_afectaciones.id_tipo_afectacion
inner join
	tc_janal_usuarios on tc_kalan_creditos_pagos.id_usuario= tc_janal_usuarios.id_usuario
inner join
	tc_mantic_personas on tc_janal_usuarios.id_persona= tc_mantic_personas.id_persona
where
  tc_kalan_creditos_pagos.id_credito= {idCredito}
{sortOrder}
      </select>  
			<select id="movimientos">
select
  tc_kalan_creditos_bitacora.id_credito_bitacora as id_key,
  tc_kalan_creditos.consecutivo,
  0 as importe,
  tc_kalan_creditos_bitacora.justificacion,
  concat(tc_mantic_personas.nombres, ' ', tc_mantic_personas.paterno, ' ', tc_mantic_personas.materno) as nombre,
  tc_kalan_creditos_estatus.nombre as estatus,
  tc_kalan_creditos_bitacora.registro
from 
  tc_kalan_creditos_bitacora
inner join
  tc_kalan_creditos on tc_kalan_creditos_bitacora.id_credito= tc_kalan_creditos.id_credito
inner join
  tc_kalan_creditos_estatus on tc_kalan_creditos_bitacora.id_credito_estatus= tc_kalan_creditos_estatus.id_credito_estatus
inner join
  tc_janal_usuarios on tc_kalan_creditos_bitacora.id_usuario= tc_janal_usuarios.id_usuario
inner join
  tc_mantic_personas on tc_janal_usuarios.id_persona= tc_mantic_personas.id_persona
where
  tc_kalan_creditos.id_credito= {idCredito}
order by
  tc_kalan_creditos.registro desc				
			</select>		
    </unit>  
    <unit id="VistaValesDto">
      <select id="lazy">
select
  tc_kalan_vales.id_vale as id_key,
  tc_kalan_vales.id_vale,
  tc_kalan_vales.id_empresa,  
  tc_mantic_empresas.nombre as empresa,  
  tc_kalan_vales.consecutivo,  													
  tc_mantic_almacenes.nombre as almacen,
  tc_kalan_vales.id_vale_estatus,
  tc_kalan_vales_estatus.nombre as estatus,
  tc_kalan_vales_estatus.estatus_asociados, 
  concat(tc_mantic_personas.nombres, ' ', tc_mantic_personas.paterno, ' ', tc_mantic_personas.materno) as nombre,
  count(tc_kalan_vales_detalles.id_vale_detalle) as articulos,
  tc_kalan_vales.registro
from 
  tc_kalan_vales						
left join 
  tc_kalan_vales_detalles on tc_kalan_vales.id_vale = tc_kalan_vales_detalles.id_vale
inner join 
  tc_mantic_empresas on tc_kalan_vales.id_empresa= tc_mantic_empresas.id_empresa
inner join 
  tc_kalan_vales_estatus on tc_kalan_vales.id_vale_estatus=tc_kalan_vales_estatus.id_vale_estatus
inner join 
  tc_mantic_almacenes on tc_kalan_vales.id_almacen= tc_mantic_almacenes.id_almacen
inner join 
  tr_mantic_empresa_personal on tc_kalan_vales.id_solicito= tr_mantic_empresa_personal.id_empresa_persona
inner join				
  tc_mantic_personas on tc_mantic_personas.id_persona= tr_mantic_empresa_personal.id_persona			
where
  tc_kalan_vales.id_empresa in ({idEmpresa})
  and {condicion}
group by 
  tc_kalan_vales.id_vale
{sortOrder}
      </select>
      <select id="detalle">
select      
  tc_kalan_vales_detalles.id_vale_detalle as id_comodin,
  tc_kalan_vales_detalles.id_vale_detalle,
  tc_kalan_vales_detalles.id_vale,
  tc_kalan_vales_detalles.id_articulo,
  ifnull(tc_kalan_vales_detalles.codigo, tc_mantic_articulos_codigos.codigo) as codigo,
  tc_kalan_vales_detalles.nombre,
  tc_kalan_vales_detalles.cantidad,
  tc_kalan_vales_detalles.costo,
  tc_kalan_vales_detalles.precio,
  tc_kalan_vales_detalles.registro
from      
  tc_kalan_vales_detalles
inner join
  tc_mantic_articulos on tc_kalan_vales_detalles.id_articulo= tc_mantic_articulos.id_articulo
left join
  tc_mantic_articulos_codigos on tc_kalan_vales_detalles.id_articulo= tc_mantic_articulos_codigos.id_articulo and tc_mantic_articulos_codigos.id_principal= 1
where      
  tc_kalan_vales_detalles.id_vale = {idVale}
order by
  tc_kalan_vales_detalles.registro
      </select>
    </unit>  
    <unit id="VistaEmpresasMovimientosDto">
      <select id="lazy">
select
  tc_kalan_empresas_movimientos.id_empresa_movimiento as id_key,
  tc_kalan_empresas_movimientos.id_empresa_movimiento,
  tc_mantic_empresas.nombre as empresa,
  tc_kalan_empresas_movimientos.consecutivo,
	tc_mantic_clientes.razon_social as cliente,
	tc_kalan_empresas_movimientos.observaciones,
	tc_kalan_empresas_movimientos.justificacion,
  tc_kalan_empresas_movimientos.fecha_aplicacion,
	tc_kalan_empresas_movimientos.total,
	tc_kalan_empresas_cuentas.nombre as cuenta,
	tc_kalan_movimientos_estatus.id_movimiento_estatus,
	tc_kalan_movimientos_estatus.nombre as estatus,
	tc_kalan_movimientos_estatus.estatus_asociados,
  tc_kalan_empresas_movimientos.id_anticipo,
  tc_janal_booleanos.descripcion as anticipo,
  tc_kalan_empresas_movimientos.concepto,
	tc_kalan_empresas_movimientos.registro
from      
  tc_kalan_empresas_movimientos
inner join
  tc_mantic_empresas on tc_kalan_empresas_movimientos.id_empresa= tc_mantic_empresas.id_empresa
left join
  tc_mantic_clientes on tc_kalan_empresas_movimientos.id_cliente= tc_mantic_clientes.id_cliente
inner join
  tc_kalan_empresas_cuentas on tc_kalan_empresas_movimientos.id_empresa_cuenta= tc_kalan_empresas_cuentas.id_empresa_cuenta
inner join 
  tc_kalan_movimientos_estatus on tc_kalan_empresas_movimientos.id_movimiento_estatus= tc_kalan_movimientos_estatus.id_movimiento_estatus
left join 
  tc_kalan_tipos_conceptos on tc_kalan_empresas_movimientos.id_tipo_concepto= tc_kalan_tipos_conceptos.id_tipo_concepto
inner join  
  tc_janal_booleanos on tc_kalan_empresas_movimientos.id_anticipo= tc_janal_booleanos.id_booleano
where        
  tc_kalan_empresas_movimientos.id_empresa in ({idEmpresa})        
	and tc_kalan_empresas_movimientos.id_tipo_movimiento= {idTipoMovimiento}
  and {condicion}
{sortOrder}
        </select>
      <select id="general">
select
  tc_kalan_empresas_movimientos.id_empresa_movimiento as id_key,
	ifnull(sum(tc_kalan_empresas_movimientos.total), 0) as total
from      
  tc_kalan_empresas_movimientos
inner join
  tc_mantic_empresas on tc_kalan_empresas_movimientos.id_empresa= tc_mantic_empresas.id_empresa
left join
  tc_mantic_clientes on tc_kalan_empresas_movimientos.id_cliente= tc_mantic_clientes.id_cliente
inner join
  tc_kalan_empresas_cuentas on tc_kalan_empresas_movimientos.id_empresa_cuenta= tc_kalan_empresas_cuentas.id_empresa_cuenta
inner join 
  tc_kalan_movimientos_estatus on tc_kalan_empresas_movimientos.id_movimiento_estatus= tc_kalan_movimientos_estatus.id_movimiento_estatus
left join 
  tc_kalan_tipos_conceptos on tc_kalan_empresas_movimientos.id_tipo_concepto= tc_kalan_tipos_conceptos.id_tipo_concepto
inner join  
  tc_janal_booleanos on tc_kalan_empresas_movimientos.id_anticipo= tc_janal_booleanos.id_booleano
where        
  tc_kalan_empresas_movimientos.id_empresa in ({idEmpresa})        
	and tc_kalan_empresas_movimientos.id_tipo_movimiento= {idTipoMovimiento}
  and {condicion}
        </select>
        <select id="movimientos">
select
  tc_kalan_movimientos_bitacora.id_movimiento_bitacora as id_key,
  tc_kalan_empresas_movimientos.consecutivo,
  0 as importe,
  ' ' as id_transporto,
  tc_kalan_movimientos_bitacora.justificacion,
  concat(tc_mantic_personas.nombres, ' ', tc_mantic_personas.paterno, ' ', tc_mantic_personas.materno) as nombre,
  tc_kalan_movimientos_estatus.nombre as estatus,
  tc_kalan_movimientos_bitacora.registro
from 
  tc_kalan_movimientos_bitacora
inner join
  tc_kalan_empresas_movimientos on tc_kalan_movimientos_bitacora.id_empresa_movimiento= tc_kalan_empresas_movimientos.id_empresa_movimiento
inner join
  tc_kalan_movimientos_estatus on tc_kalan_movimientos_bitacora.id_movimiento_estatus= tc_kalan_movimientos_estatus.id_movimiento_estatus
inner join
  tc_janal_usuarios on tc_kalan_movimientos_bitacora.id_usuario= tc_janal_usuarios.id_usuario
inner join
  tc_mantic_personas on tc_janal_usuarios.id_persona= tc_mantic_personas.id_persona
where
  tc_kalan_movimientos_bitacora.id_empresa_movimiento= {idEmpresaMovimiento}
order by
  tc_kalan_movimientos_bitacora.registro desc
			</select>		 
      <select id="acumulados">
select
	998 as id_key,
  998 as id_gasto_clasificacion,
	tc_mantic_empresas.titulo as empresa,
	'INGRESOS VARIOS' as clasificacion,
	'{anterior}' as fecha_anterior,
	round(sum(if(date_format(tc_kalan_empresas_movimientos.fecha_aplicacion, '%Y|%m')= '{anterior}', tc_kalan_empresas_movimientos.total, 0)), 2) as anterior,
	'{actual}' as fecha_actual,
	round(sum(if(date_format(tc_kalan_empresas_movimientos.fecha_aplicacion, '%Y|%m')= '{actual}', tc_kalan_empresas_movimientos.total, 0)), 2) as actual
from
	tc_kalan_empresas_movimientos
inner join
  tc_mantic_empresas on tc_kalan_empresas_movimientos.id_empresa= tc_mantic_empresas.id_empresa
inner join 
  tc_kalan_movimientos_estatus on tc_kalan_empresas_movimientos.id_movimiento_estatus= tc_kalan_movimientos_estatus.id_movimiento_estatus
where
  tc_kalan_empresas_movimientos.id_empresa= {idEmpresa}              
	and tc_kalan_movimientos_estatus.id_movimiento_estatus= 2
	and (date_format(tc_kalan_empresas_movimientos.fecha_aplicacion, '%Y|%m')= '{anterior}' or date_format(tc_kalan_empresas_movimientos.fecha_aplicacion, '%Y|%m')= '{actual}')
group by
  tc_mantic_empresas.id_empresa
      </select>            
      <select id="detalle"> 
select
	tc_kalan_empresas_movimientos.id_empresa_movimiento as id_key,
  tc_mantic_empresas.nombre as empresa,
  tc_kalan_empresas_movimientos.consecutivo,
  ' ' as clasificacion,
  ' ' as subclasificacion,
	tc_kalan_empresas_movimientos.fecha_aplicacion,
  tc_kalan_empresas_movimientos.concepto,
	tc_kalan_empresas_movimientos.observaciones,
	tc_kalan_empresas_movimientos.total,
	tc_kalan_movimientos_estatus.id_movimiento_estatus as id_gasto_estatus,
	tc_kalan_empresas_movimientos.registro
from
	tc_kalan_empresas_movimientos
inner join  
  tc_mantic_empresas on tc_kalan_empresas_movimientos.id_empresa= tc_mantic_empresas.id_empresa
left join 
  tc_kalan_tipos_conceptos on tc_kalan_empresas_movimientos.id_tipo_concepto= tc_kalan_tipos_conceptos.id_tipo_concepto
inner join 
  tc_kalan_movimientos_estatus on tc_kalan_empresas_movimientos.id_movimiento_estatus= tc_kalan_movimientos_estatus.id_movimiento_estatus
where
  tc_kalan_empresas_movimientos.id_empresa in ({idEmpresa})
	and tc_kalan_movimientos_estatus.id_movimiento_estatus= 2
	and date_format(tc_kalan_empresas_movimientos.fecha_aplicacion, '%Y|%m')= '{fecha}'
{sortOrder}
      </select>            
    </unit>  
    <unit id="VistaEmpresasGastosDto">
      <select id="lazy">
select
	tc_kalan_empresas_gastos.id_empresa_gasto as id_key,
	tc_kalan_empresas_gastos.id_empresa_gasto,
	tc_kalan_empresas_gastos.id_fuente,
  tc_kalan_gastos_clasificaciones.id_gasto_clasificacion,
	tc_mantic_empresas.nombre as empresa,
  tc_kalan_empresas_gastos.consecutivo,
	tc_kalan_gastos_clasificaciones.descripcion as clasificacion,
	tc_kalan_gastos_subclasificaciones.descripcion as subclasificacion,
	tc_kalan_empresas_gastos.fecha_aplicacion,
	tc_kalan_empresas_gastos.fecha_referencia,
	tc_kalan_empresas_gastos.referencia,
	tc_mantic_proveedores.razon_social as proveedor,
	tc_kalan_empresas_gastos.concepto,
	tc_kalan_empresas_gastos.observaciones,
	tc_kalan_empresas_gastos.total,
	tc_kalan_empresas_gastos.pago,
	tc_kalan_empresas_gastos.pagos,
	tc_kalan_empresas_cuentas.nombre as cuenta,
	tc_kalan_gastos_estatus.id_gasto_estatus,
	tc_kalan_gastos_estatus.nombre as estatus,
	tc_kalan_gastos_estatus.estatus_asociados,
  tc_kalan_empresas_gastos.id_activo_prorratear,
	tc_kalan_empresas_gastos.registro
from
	tc_kalan_empresas_gastos
inner join
  tc_mantic_empresas on tc_kalan_empresas_gastos.id_empresa= tc_mantic_empresas.id_empresa
inner join
  tc_kalan_gastos_clasificaciones	on tc_kalan_empresas_gastos.id_gasto_clasificacion= tc_kalan_gastos_clasificaciones.id_gasto_clasificacion
inner join
  tc_kalan_gastos_subclasificaciones on tc_kalan_empresas_gastos.id_gasto_subclasificacion= tc_kalan_gastos_subclasificaciones.id_gasto_subclasificacion
left join
  tc_mantic_proveedores on tc_kalan_empresas_gastos.id_proveedor= tc_mantic_proveedores.id_proveedor
left join
  tc_kalan_empresas_cuentas on tc_kalan_empresas_gastos.id_empresa_cuenta= tc_kalan_empresas_cuentas.id_empresa_cuenta
inner join 
  tc_kalan_gastos_estatus on tc_kalan_empresas_gastos.id_gasto_estatus= tc_kalan_gastos_estatus.id_gasto_estatus
where
  tc_kalan_empresas_gastos.id_empresa in ({idEmpresa})        
	and (tc_kalan_empresas_gastos.id_fuente= {idFuente} or (tc_kalan_empresas_gastos.pagos= 0 and tc_kalan_empresas_gastos.pago= 1))
  and {condicion}
{sortOrder}
      </select>
      <select id="general">
select
	tc_kalan_empresas_gastos.id_empresa_gasto as id_key,
	ifnull(sum(tc_kalan_empresas_gastos.total), 0) as total
from
	tc_kalan_empresas_gastos
inner join
  tc_mantic_empresas on tc_kalan_empresas_gastos.id_empresa= tc_mantic_empresas.id_empresa
inner join
  tc_kalan_gastos_clasificaciones	on tc_kalan_empresas_gastos.id_gasto_clasificacion= tc_kalan_gastos_clasificaciones.id_gasto_clasificacion
inner join
  tc_kalan_gastos_subclasificaciones on tc_kalan_empresas_gastos.id_gasto_subclasificacion= tc_kalan_gastos_subclasificaciones.id_gasto_subclasificacion
left join
  tc_mantic_proveedores on tc_kalan_empresas_gastos.id_proveedor= tc_mantic_proveedores.id_proveedor
left join
  tc_kalan_empresas_cuentas on tc_kalan_empresas_gastos.id_empresa_cuenta= tc_kalan_empresas_cuentas.id_empresa_cuenta
inner join 
  tc_kalan_gastos_estatus on tc_kalan_empresas_gastos.id_gasto_estatus= tc_kalan_gastos_estatus.id_gasto_estatus
where
  tc_kalan_empresas_gastos.id_empresa in ({idEmpresa})        
	and (tc_kalan_empresas_gastos.id_fuente= {idFuente} or (tc_kalan_empresas_gastos.pagos= 0 and tc_kalan_empresas_gastos.pago= 1))
  and {condicion}
      </select>
      <select id="detalle">
select
	tc_kalan_empresas_gastos.id_empresa_gasto as id_key,
  tc_mantic_empresas.nombre as empresa,
  tc_kalan_empresas_gastos.consecutivo,
	tc_kalan_gastos_clasificaciones.descripcion as clasificacion,
	tc_kalan_gastos_subclasificaciones.descripcion as subclasificacion,
	tc_kalan_empresas_gastos.fecha_aplicacion,
  tc_kalan_empresas_gastos.concepto,
	tc_kalan_empresas_gastos.observaciones,
	tc_kalan_empresas_gastos.total,
	tc_kalan_gastos_estatus.id_gasto_estatus,
	tc_kalan_empresas_gastos.registro
from
	tc_kalan_empresas_gastos
inner join  
  tc_mantic_empresas on tc_kalan_empresas_gastos.id_empresa= tc_mantic_empresas.id_empresa
inner join
  tc_kalan_gastos_clasificaciones	on tc_kalan_empresas_gastos.id_gasto_clasificacion= tc_kalan_gastos_clasificaciones.id_gasto_clasificacion
inner join
  tc_kalan_gastos_subclasificaciones on tc_kalan_empresas_gastos.id_gasto_subclasificacion= tc_kalan_gastos_subclasificaciones.id_gasto_subclasificacion
inner join 
  tc_kalan_gastos_estatus on tc_kalan_empresas_gastos.id_gasto_estatus= tc_kalan_gastos_estatus.id_gasto_estatus
where
  tc_kalan_empresas_gastos.id_empresa in ({idEmpresa})        
  and tc_kalan_empresas_gastos.id_gasto_clasificacion= {idGastoClasificacion}
	and (tc_kalan_empresas_gastos.id_fuente= 2 or (tc_kalan_empresas_gastos.id_activo_prorratear= 2 and tc_kalan_empresas_gastos.id_fuente= 1))
	and tc_kalan_gastos_estatus.id_gasto_estatus= 2
	and date_format(tc_kalan_empresas_gastos.fecha_aplicacion, '%Y|%m')= '{fecha}'        
{sortOrder}        
      </select>  
      <select id="control">  
select
  tc_kalan_empresas_gastos.id_empresa_gasto as id_key,
  tc_kalan_empresas_gastos.*,
	tc_kalan_gastos_estatus.nombre as estatus,
	tc_kalan_gastos_estatus.estatus_asociados
from
  tc_kalan_empresas_gastos
inner join  
  tc_kalan_empresas_controles on tc_kalan_empresas_gastos.id_empresa_gasto= tc_kalan_empresas_controles.id_gasto_control
inner join 
  tc_kalan_gastos_estatus on tc_kalan_empresas_gastos.id_gasto_estatus= tc_kalan_gastos_estatus.id_gasto_estatus
where  
  tc_kalan_empresas_controles.id_empresa_gasto= {idEmpresaGasto}
{sortOrder}                
      </select>  
      <select id="fuente">  
select
  tc_kalan_empresas_gastos.id_empresa_gasto as id_key,
  tc_kalan_empresas_gastos.*
from
  tc_kalan_empresas_gastos
inner join ( 
  select
    tc_kalan_empresas_controles.id_empresa_gasto
  from  
    tc_kalan_empresas_controles 
  where  
    tc_kalan_empresas_controles.id_gasto_control= {idEmpresaGasto}
) as tt_kalan_empresas_controles on tc_kalan_empresas_gastos.id_empresa_gasto= tt_kalan_empresas_controles.id_empresa_gasto        
      </select>  
      <select id="acumulados">
select
	tc_kalan_gastos_clasificaciones.id_gasto_clasificacion as id_key,
  tc_kalan_gastos_clasificaciones.id_gasto_clasificacion,
	tc_mantic_empresas.titulo as empresa,
	tc_kalan_gastos_clasificaciones.descripcion as clasificacion,
	'{anterior}' as fecha_anterior,
	sum(if(date_format(tc_kalan_empresas_gastos.fecha_aplicacion, '%Y|%m')= '{anterior}', tc_kalan_empresas_gastos.total, 0)) as anterior,
	'{actual}' as fecha_actual,
	sum(if(date_format(tc_kalan_empresas_gastos.fecha_aplicacion, '%Y|%m')= '{actual}', tc_kalan_empresas_gastos.total, 0)) as actual
from
	tc_kalan_empresas_gastos
inner join
  tc_mantic_empresas on tc_kalan_empresas_gastos.id_empresa= tc_mantic_empresas.id_empresa
inner join
  tc_kalan_gastos_clasificaciones	on tc_kalan_empresas_gastos.id_gasto_clasificacion= tc_kalan_gastos_clasificaciones.id_gasto_clasificacion
where
  tc_kalan_empresas_gastos.id_empresa= {idEmpresa}              
	and (tc_kalan_empresas_gastos.id_fuente= 2 or (tc_kalan_empresas_gastos.id_activo_prorratear= 2 and tc_kalan_empresas_gastos.id_fuente= 1))
	and tc_kalan_empresas_gastos.id_gasto_estatus= 2
	and (date_format(tc_kalan_empresas_gastos.fecha_aplicacion, '%Y|%m')= '{anterior}' or date_format(tc_kalan_empresas_gastos.fecha_aplicacion, '%Y|%m')= '{actual}')
group by
  tc_mantic_empresas.id_empresa,
  tc_kalan_gastos_clasificaciones.id_gasto_clasificacion
order by  
  tc_kalan_gastos_clasificaciones.descripcion
      </select>
      <select id="individual">
select
	tc_kalan_gastos_clasificaciones.id_gasto_clasificacion as id_key,
	tc_mantic_empresas.titulo as empresa,
	tc_kalan_gastos_clasificaciones.descripcion as clasificacion,
	tc_kalan_gastos_subclasificaciones.descripcion as sub_clasificacion,
	'{anterior}' as fecha_anterior,
	sum(if(date_format(tc_kalan_empresas_gastos.fecha_aplicacion, '%Y|%m')= '{anterior}', tc_kalan_empresas_gastos.total, 0)) as anterior,
	'{actual}' as fecha_actual,
	sum(if(date_format(tc_kalan_empresas_gastos.fecha_aplicacion, '%Y|%m')= '{actual}', tc_kalan_empresas_gastos.total, 0)) as actual
from
	tc_kalan_empresas_gastos
inner join
  tc_mantic_empresas on tc_kalan_empresas_gastos.id_empresa= tc_mantic_empresas.id_empresa
inner join
  tc_kalan_gastos_clasificaciones	on tc_kalan_empresas_gastos.id_gasto_clasificacion= tc_kalan_gastos_clasificaciones.id_gasto_clasificacion and tc_kalan_gastos_clasificaciones.id_activo= 1
inner join
  tc_kalan_gastos_subclasificaciones on tc_kalan_empresas_gastos.id_gasto_clasificacion= tc_kalan_gastos_subclasificaciones.id_gasto_clasificacion and tc_kalan_empresas_gastos.id_gasto_subclasificacion= tc_kalan_gastos_subclasificaciones.id_gasto_subclasificacion and tc_kalan_gastos_subclasificaciones.id_activo= 1
where
  tc_kalan_empresas_gastos.id_empresa= {idEmpresa}
	and (tc_kalan_empresas_gastos.id_fuente= 2 or (tc_kalan_empresas_gastos.id_activo_prorratear= 2 and tc_kalan_empresas_gastos.id_fuente= 1))
	and tc_kalan_empresas_gastos.id_gasto_estatus= 2
	and (date_format(tc_kalan_empresas_gastos.fecha_aplicacion, '%Y|%m')= '{anterior}' or date_format(tc_kalan_empresas_gastos.fecha_aplicacion, '%Y|%m')= '{actual}')
	and tc_kalan_gastos_clasificaciones.id_gasto_clasificacion= {idGastoClasificacion}
group by
  tc_mantic_empresas.id_empresa,
  tc_kalan_gastos_clasificaciones.id_gasto_clasificacion,
  tc_kalan_gastos_subclasificaciones.id_gasto_subclasificacion
order by  
  tc_kalan_gastos_subclasificaciones.descripcion
      </select>
      <select id="desglosado">
select
	tc_kalan_empresas_gastos.id_empresa_gasto as id_key,
	tc_mantic_empresas.titulo as empresa,
	tc_kalan_empresas_gastos.consecutivo,
	tc_mantic_proveedores.razon_social as proveedor,
	tc_kalan_empresas_gastos.fecha_aplicacion,
	tc_kalan_empresas_gastos.concepto,
	tc_kalan_empresas_gastos.observaciones,
	tc_kalan_empresas_gastos.total
from
	tc_kalan_empresas_gastos
inner join
  tc_mantic_empresas on tc_kalan_empresas_gastos.id_empresa= tc_mantic_empresas.id_empresa
inner join
  tc_kalan_gastos_clasificaciones	on tc_kalan_empresas_gastos.id_gasto_clasificacion= tc_kalan_gastos_clasificaciones.id_gasto_clasificacion and tc_kalan_gastos_clasificaciones.id_activo= 1
inner join
  tc_kalan_gastos_subclasificaciones on tc_kalan_empresas_gastos.id_gasto_clasificacion= tc_kalan_gastos_subclasificaciones.id_gasto_clasificacion and tc_kalan_empresas_gastos.id_gasto_subclasificacion= tc_kalan_gastos_subclasificaciones.id_gasto_subclasificacion and tc_kalan_gastos_subclasificaciones.id_activo= 1
left join
  tc_mantic_proveedores on tc_kalan_empresas_gastos.id_proveedor= tc_mantic_proveedores.id_proveedor
where
  tc_kalan_empresas_gastos.id_empresa= {idEmpresa}
	and (tc_kalan_empresas_gastos.id_fuente= 2 or (tc_kalan_empresas_gastos.id_activo_prorratear= 2 and tc_kalan_empresas_gastos.id_fuente= 1))
	and tc_kalan_empresas_gastos.id_gasto_estatus= 2
	and date_format(tc_kalan_empresas_gastos.fecha_aplicacion, '%Y|%m')= '{fecha}'
	and tc_kalan_gastos_clasificaciones.id_gasto_clasificacion= {idGastoClasificacion}
	and tc_kalan_gastos_subclasificaciones.id_gasto_subclasificacion= {idGastoSubclasificacion}
group by
  tc_mantic_empresas.id_empresa,
  tc_kalan_empresas_gastos.id_empresa_gasto
order by  
  tc_kalan_gastos_subclasificaciones.descripcion
      </select>
      <select id="proveedores">
select
  tc_mantic_proveedores.id_proveedor as id_key,
  tc_mantic_proveedores.clave,  
  tc_mantic_proveedores.razon_social as nombre,
  tc_mantic_proveedores.dias_entrega
from 
  tc_kalan_empresas_gastos
inner join
  tc_mantic_proveedores on tr_mantic_proveedor_pago.id_proveedor= tc_mantic_proveedores.id_proveedor       
where 		
  tc_kalan_empresas_gastos.id_empresa in ({sucursales})
group by
  tc_mantic_proveedores.id_proveedor		
order by
  tc_mantic_proveedores.clave
			</select>      
			<select id="movimientos">
select
  tc_kalan_gastos_bitacora.id_gasto_bitacora as id_key,
  tc_kalan_empresas_gastos.consecutivo,
  0 as importe,
  ' ' as id_transporto,
  tc_kalan_gastos_bitacora.justificacion,
  concat(tc_mantic_personas.nombres, ' ', tc_mantic_personas.paterno, ' ', tc_mantic_personas.materno) as nombre,
  tc_kalan_gastos_estatus.nombre as estatus,
  tc_kalan_gastos_bitacora.registro
from 
  tc_kalan_gastos_bitacora
inner join
  tc_kalan_empresas_gastos on tc_kalan_gastos_bitacora.id_empresa_gasto= tc_kalan_empresas_gastos.id_empresa_gasto
inner join
  tc_kalan_gastos_estatus on tc_kalan_gastos_bitacora.id_gasto_estatus= tc_kalan_gastos_estatus.id_gasto_estatus
inner join
  tc_janal_usuarios on tc_kalan_gastos_bitacora.id_usuario= tc_janal_usuarios.id_usuario
inner join
  tc_mantic_personas on tc_janal_usuarios.id_persona= tc_mantic_personas.id_persona
where
  tc_kalan_gastos_bitacora.id_empresa_gasto= {idEmpresaGasto}
order by
  tc_kalan_gastos_bitacora.registro desc
			</select>		       
    </unit>    
    <unit id="VistaArticuloPrecioDto">
      <select id="lazy">
select 
  tc_mantic_articulos.id_articulo as id_key,
  tc_mantic_articulos.id_vigente,
  tc_mantic_articulos.nombre,
  tc_mantic_articulos.descripcion,
  tc_mantic_articulos.sat,
  tc_mantic_articulos.precio,
  tc_mantic_articulos.menudeo,
  tc_mantic_articulos.medio_mayoreo,
  tc_mantic_articulos.mayoreo,
  tc_mantic_articulos.especial,
  tc_mantic_articulos.iva,
  tc_mantic_articulos.desperdicio,
  tc_mantic_articulos.actualizado,
  tc_mantic_articulos_codigos.codigo as propio,
  if(tc_mantic_articulos.id_facturama is null, -1, tc_mantic_articulos.id_facturama) id_facturama,
  ifnull(tc_mantic_articulos.id_imagen, 0) as id_imagen,
  ifnull(tc_mantic_imagenes.alias, ' ') as alias,
  tc_mantic_articulos.factor
from 
  tc_mantic_articulos
left join
  tc_mantic_imagenes on tc_mantic_articulos.id_imagen = tc_mantic_imagenes.id_imagen
inner join
  tc_mantic_articulos_codigos on tc_mantic_articulos.id_articulo = tc_mantic_articulos_codigos.id_articulo and tc_mantic_articulos_codigos.id_principal= 1
inner join 
  tc_mantic_empresas on tc_mantic_articulos.id_empresa = tc_mantic_empresas.id_empresa
inner join
  tr_mantic_empaque_unidad_medida on tc_mantic_articulos.id_empaque_unidad_medida = tr_mantic_empaque_unidad_medida.id_empaque_unidad_medida
inner join 
  tc_mantic_empaques on tr_mantic_empaque_unidad_medida.id_empaque = tc_mantic_empaques.id_empaque
inner join 
  tc_mantic_unidades_medidas on tr_mantic_empaque_unidad_medida.id_unidad_medida = tc_mantic_unidades_medidas.id_unidad_medida
where 
  tc_mantic_empresas.id_empresa in ({idEmpresa})
  and {condicion}					
group by 
  tc_mantic_articulos.id_articulo
{sortOrder}        
      </select>
    </unit>  
    <unit id="VistaCitasDiagnosticosDto">
      <select id="lazy">
select      
  tc_kalan_citas.id_cita as id_key,
  tc_kalan_citas.id_cita,
  tc_kalan_citas.consecutivo,
  tc_kalan_citas.inicio,
  tc_kalan_citas.termino,
  tc_kalan_diagnosticos.diagnostico,
  tc_kalan_diagnosticos.tratamiento,
  tc_kalan_diagnosticos.registro
from
  tc_kalan_citas
left join  
  tc_kalan_diagnosticos on tc_kalan_citas.id_cita= tc_kalan_diagnosticos.id_cita
where
  tc_kalan_citas.id_cliente= {idCliente}
  and {condicion}
{sortOrder}
      </select>
    </unit>  
    <unit id="VistaExpedientesDto">
      <select id="lazy">
select      
  tc_kalan_expedientes.id_expediente as id_key,
  tc_kalan_expedientes.*,
  tc_kalan_citas.consecutivo,
  tc_mantic_tipos_archivos.nombre as tipo
from      
  tc_kalan_expedientes
inner join 
  tc_mantic_tipos_archivos on tc_kalan_expedientes.id_tipo_archivo= tc_mantic_tipos_archivos.id_tipo_archivo
left join
 tc_kalan_citas on tc_kalan_expedientes.id_cita= tc_kalan_citas.id_cita
where
  tc_kalan_expedientes.id_cliente= {idCliente}
  and tc_kalan_expedientes.id_expediente_estatus in (1, 3)
  and {condicion}
{sortOrder}        
      </select>
      <select id="recordatorios">
select
  tc_kalan_citas.id_cita as id_key,
  tc_kalan_citas.id_cita,
  tc_mantic_clientes.id_cliente,        
  timestampdiff(hour, now(), tc_kalan_citas.inicio) as horas,
  concat(tc_mantic_clientes.razon_social, ' ', ifnull(tc_mantic_clientes.paterno, ''), ' ', ifnull(tc_mantic_clientes.materno, '')) as cliente,
  tt_mantic_cliente_celular.celular,
  tc_kalan_citas.inicio,
  tc_kalan_citas.recordatorio,
  tc_kalan_citas.observaciones
from
  tc_kalan_citas
inner join  
  tc_mantic_clientes on tc_kalan_citas.id_cliente= tc_mantic_clientes.id_cliente
left join (
  select
    tr_mantic_cliente_tipo_contacto.id_cliente,
    tr_mantic_cliente_tipo_contacto.valor as celular
  from
    tr_mantic_cliente_tipo_contacto
  where
    tr_mantic_cliente_tipo_contacto.id_tipo_contacto in (6, 7, 8)
    and tr_mantic_cliente_tipo_contacto.id_preferido= 1
  group by
    tr_mantic_cliente_tipo_contacto.id_cliente              
  order by
    tr_mantic_cliente_tipo_contacto.orden      
) as tt_mantic_cliente_celular on tc_mantic_clientes.id_cliente= tt_mantic_cliente_celular.id_cliente
where
  timestampdiff(hour, now(), tc_kalan_citas.inicio)&lt;= tc_kalan_citas.recordatorio
  and tc_kalan_citas.recordado is null
  and tc_kalan_citas.id_cita_estatus in (1, 5)  
  and tt_mantic_cliente_celular.celular is not null
  and tc_kalan_citas.recordatorio> 0
group by
  tc_kalan_citas.id_cita,
  tc_mantic_clientes.id_cliente
      </select>  
      <select id="notificaciones">
select
  tc_kalan_citas.id_cita as id_key,
  tc_kalan_citas.id_cita,
  tc_mantic_clientes.id_cliente,
  timestampdiff(hour, now(), tc_kalan_citas.inicio) as horas,
  concat(tc_mantic_clientes.razon_social, ' ', ifnull(tc_mantic_clientes.paterno, ''), ' ', ifnull(tc_mantic_clientes.materno, '')) as cliente,
  tt_mantic_cliente_celular.celular,
  tc_kalan_citas.inicio,
  tc_kalan_citas.notificacion,
  tc_kalan_citas.observaciones
from
  tc_kalan_citas
inner join  
  tc_mantic_clientes on tc_kalan_citas.id_cliente= tc_mantic_clientes.id_cliente
left join (
  select
    tr_mantic_cliente_tipo_contacto.id_cliente,
    tr_mantic_cliente_tipo_contacto.valor as celular
  from
    tr_mantic_cliente_tipo_contacto
  where
    tr_mantic_cliente_tipo_contacto.id_tipo_contacto in (6, 7, 8)
    and tr_mantic_cliente_tipo_contacto.id_preferido= 1
  group by
    tr_mantic_cliente_tipo_contacto.id_cliente              
  order by
    tr_mantic_cliente_tipo_contacto.orden      
) as tt_mantic_cliente_celular on tc_mantic_clientes.id_cliente= tt_mantic_cliente_celular.id_cliente
where
  timestampdiff(hour, now(), tc_kalan_citas.inicio)&lt;= tc_kalan_citas.notificacion
  and tc_kalan_citas.notificado is null
  and tc_kalan_citas.id_cita_estatus in (1, 5)  
  and tt_mantic_cliente_celular.celular is not null
  and tc_kalan_citas.notificacion> 0
group by
  tc_kalan_citas.id_cita,
  tc_mantic_clientes.id_cliente
      </select>  
    </unit>    
    <unit id="VistaClientesCitasDto">
      <select id="lazy">
select
  tc_kalan_citas.id_cita as id_key,
  tc_kalan_citas.id_cita,
  tc_kalan_citas.id_cliente,
  tc_mantic_clientes.clave,
  tc_mantic_clientes.rfc,
  concat(tc_mantic_clientes.razon_social, ' ', ifnull(tc_mantic_clientes.paterno, ''), ' ', ifnull(tc_mantic_clientes.materno, '')) as cliente,
  tc_kalan_citas.consecutivo,
  tc_kalan_citas.id_cita_estatus,
  tc_kalan_citas.inicio,
  tc_kalan_citas.termino,
  tc_kalan_citas.inicio as inicia,
  tc_kalan_citas.termino as termina,
  tc_kalan_citas.recordatorio,
  tc_mantic_clientes.limite_credito,
  tc_mantic_clientes.saldo,
  tc_kalan_citas_estatus.nombre as estatus,
  concat(tc_mantic_personas.nombres, ' ', tc_mantic_personas.paterno, ' ', tc_mantic_personas.materno) as atendio,      
  tc_kalan_citas.observaciones as comentarios,
  tc_kalan_citas.registro,
  group_concat(tc_mantic_articulos.nombre separator ', ') as servicios        
from      
  tc_mantic_clientes
inner join ( 
	select
		tc_kalan_citas.id_cita as id_cita,
    tc_kalan_citas.id_cliente
	from
		tc_kalan_citas
	where
	  (tc_kalan_citas.id_cliente= {idCliente} or {idCliente}= -1)        
    and tc_kalan_citas.id_cita_estatus!= 6
	group by	
	 tc_kalan_citas.id_cliente,
	 tc_kalan_citas.id_cita
) as tt_kalan_citas on tc_mantic_clientes.id_cliente= tt_kalan_citas.id_cliente
inner join
  tc_kalan_citas on tt_kalan_citas.id_cita= tc_kalan_citas.id_cita
inner join
  tc_kalan_citas_detalles on tc_kalan_citas.id_cita= tc_kalan_citas_detalles.id_cita
inner join
  tc_mantic_articulos on tc_kalan_citas_detalles.id_articulo= tc_mantic_articulos.id_articulo
inner join
  tc_kalan_citas_estatus on tc_kalan_citas.id_cita_estatus= tc_kalan_citas_estatus.id_cita_estatus
left join
  tc_janal_usuarios on tc_kalan_citas.id_atendio= tc_janal_usuarios.id_usuario          
left join
  tc_mantic_personas on tc_janal_usuarios.id_persona= tc_mantic_personas.id_persona
where 
  tc_mantic_clientes.id_empresa in ({sucursales})
  and tc_mantic_clientes.id_cliente> 1
  and {condicion}
group by
  tc_mantic_clientes.id_cliente,
  tc_kalan_citas.id_cita
{sortOrder}
      </select>
      <select id="clientes">
select      
  tc_mantic_clientes.id_cliente as id_key,
  tc_kalan_citas.id_cita,
  tc_kalan_citas.id_cita_estatus,
  tc_mantic_clientes.id_cliente,
  tc_mantic_clientes.clave,
  tc_mantic_clientes.rfc,
  tc_mantic_clientes.razon_social,
  ifnull(tc_mantic_clientes.paterno, '') as paterno,
  ifnull(tc_mantic_clientes.materno, '') as materno,
  tc_mantic_clientes.limite_credito,
  tc_mantic_clientes.saldo,
  concat(tc_mantic_clientes.razon_social, ' ', ifnull(tc_mantic_clientes.paterno, ''), ' ', ifnull(tc_mantic_clientes.materno, '')) as cliente,
  tc_kalan_citas.consecutivo,
  tc_kalan_citas.inicio,
  tc_kalan_citas.termino,
  tc_kalan_citas.registro,
  ifnull(group_concat(tc_mantic_articulos.nombre separator ', '), '') as servicios,
  tc_kalan_citas_estatus.nombre as estatus
from      
  tc_mantic_clientes
left join ( 
	select
		max(tc_kalan_citas.id_cita) as id_cita,
    tc_kalan_citas.id_cliente
	from
		tc_kalan_citas
	where
		(tc_kalan_citas.id_cliente= {idCliente} or {idCliente}= -1)
    and tc_kalan_citas.id_cita_estatus!= 6
	group by	
	 tc_kalan_citas.id_cliente
) as tt_kalan_citas on tc_mantic_clientes.id_cliente= tt_kalan_citas.id_cliente
left join
  tc_kalan_citas on tt_kalan_citas.id_cita= tc_kalan_citas.id_cita
left join
  tc_kalan_citas_estatus on tc_kalan_citas.id_cita_estatus= tc_kalan_citas_estatus.id_cita_estatus
left join
  tc_kalan_citas_detalles on tc_kalan_citas.id_cita= tc_kalan_citas_detalles.id_cita
left join
  tc_mantic_articulos on tc_kalan_citas_detalles.id_articulo= tc_mantic_articulos.id_articulo
where 
  tc_mantic_clientes.id_empresa in ({sucursales})
  and tc_mantic_clientes.id_cliente> 1
  and {condicion}
group by
  tc_mantic_clientes.id_cliente       
order by
  tc_mantic_clientes.razon_social, 
  tc_mantic_clientes.paterno, 
  tc_mantic_clientes.materno
      </select>
      <select id="agenda">
select      
  tc_kalan_citas.id_cita as id_key,
  tc_kalan_citas.id_cita,
  tc_kalan_citas.id_cita_estatus,
  tc_mantic_clientes.id_cliente,
  tc_mantic_clientes.clave,
  tc_mantic_clientes.rfc,
  tc_mantic_clientes.razon_social,
  tc_mantic_clientes.paterno,
  tc_mantic_clientes.materno,
  tc_mantic_clientes.limite_credito,
  tc_mantic_clientes.saldo,
  if(tc_mantic_clientes.razon_social is null, ' ', concat(tc_mantic_clientes.razon_social, ' ', ifnull(tc_mantic_clientes.paterno, ''), ' ', ifnull(tc_mantic_clientes.materno, ''))) as cliente,
  tc_kalan_citas.consecutivo,
  tc_kalan_citas.inicio,
  tc_kalan_citas.termino,
  tc_kalan_citas.inicio as inicia,
  tc_kalan_citas.termino as termina,
  tc_kalan_citas.registro,
  group_concat(tc_mantic_articulos.nombre separator ', ') as servicios,
  tc_kalan_citas_estatus.nombre as estatus
from      
  tc_kalan_citas
left join
  tc_mantic_clientes on tc_kalan_citas.id_cliente= tc_mantic_clientes.id_cliente
left join
  tc_kalan_citas_detalles on tc_kalan_citas.id_cita= tc_kalan_citas_detalles.id_cita
left join
  tc_mantic_articulos on tc_kalan_citas_detalles.id_articulo= tc_mantic_articulos.id_articulo
left join
  tc_kalan_citas_estatus on tc_kalan_citas.id_cita_estatus= tc_kalan_citas_estatus.id_cita_estatus
where 
  tc_kalan_citas.id_cita_estatus!= 6
  and date_format(tc_kalan_citas.inicio, '%Y%m%d')&gt;= '{inicio}'
  and date_format(tc_kalan_citas.inicio, '%Y%m%d')&lt;= '{termino}'
  and {condicion}
group by
  tc_kalan_citas.id_cita,
  tc_mantic_clientes.id_cliente
order by
  tc_kalan_citas.id_cita,
  tc_mantic_clientes.razon_social, 
  tc_mantic_clientes.paterno, 
  tc_mantic_clientes.materno
      </select>
      <select id="personas">
select
  tc_mantic_personas.id_persona as id_key,
  tc_mantic_personas.id_persona,
  tr_mantic_empresa_personal.id_empresa_persona,
  tc_mantic_personas.rfc,
  concat(tc_mantic_personas.nombres, ' ', ifnull(tc_mantic_personas.paterno, ''), ' ', ifnull(tc_mantic_personas.materno, '')) as empleado,
  tt_mantic_persona_celular.celular,
  tt_mantic_persona_correo.correo
from
  tr_mantic_empresa_personal
left join (
  select
    tr_mantic_persona_tipo_contacto.id_persona,
    tr_mantic_persona_tipo_contacto.valor as celular
  from
    tr_mantic_persona_tipo_contacto
  where
    tr_mantic_persona_tipo_contacto.id_tipo_contacto in (6, 7, 8)
    and tr_mantic_persona_tipo_contacto.id_preferido= 1
  order by
    tr_mantic_persona_tipo_contacto.orden      
) as tt_mantic_persona_celular on tr_mantic_empresa_personal.id_persona= tt_mantic_persona_celular.id_persona
left join (
  select
    tr_mantic_persona_tipo_contacto.id_persona,
    tr_mantic_persona_tipo_contacto.valor as correo
  from
    tr_mantic_persona_tipo_contacto
  where
    tr_mantic_persona_tipo_contacto.id_tipo_contacto in (9, 10, 11)
    and tr_mantic_persona_tipo_contacto.id_preferido= 1
  order by
    tr_mantic_persona_tipo_contacto.orden      
) as tt_mantic_persona_correo on tr_mantic_empresa_personal.id_persona= tt_mantic_persona_correo.id_persona
inner join
  tc_mantic_personas on tr_mantic_empresa_personal.id_persona= tc_mantic_personas.id_persona
where
  tr_mantic_empresa_personal.id_empresa in ({sucursales})
  and tr_mantic_empresa_personal.id_activo= 1
  and tc_mantic_personas.id_tipo_persona!= 1
  and tr_mantic_empresa_personal.id_puesto in (1, 2, 3, 4, 5)
  and {condicion}
group by
  tc_mantic_personas.id_persona               
order by
  tc_mantic_personas.nombres, 
  tc_mantic_personas.paterno,
  tc_mantic_personas.materno	
      </select>
      <select id="citados">
select
  tc_mantic_personas.id_persona as id_key,
  tc_mantic_personas.id_persona,
  tc_mantic_empresas.nombre as empresa,
  tr_mantic_empresa_personal.id_empresa_persona,
  tc_mantic_personas.rfc,
  concat(tc_mantic_personas.nombres, ' ', ifnull(tc_mantic_personas.paterno, ''), ' ', ifnull(tc_mantic_personas.materno, '')) as empleado,
  tt_mantic_persona_celular.celular,
  tt_mantic_persona_correo.correo,
  ifnull((select count(*) from tc_kalan_citas where tc_kalan_citas.id_atendio= tr_mantic_empresa_personal.id_empresa_persona and date_format(tc_kalan_citas.inicio, '%Y%m%d')= '{fecha}' group by tc_kalan_citas.id_cliente), 0) as citados
from
  tr_mantic_empresa_personal
inner join 
  tc_mantic_empresas on tr_mantic_empresa_personal.id_empresa= tc_mantic_empresas.id_empresa
left join (
  select
    tr_mantic_persona_tipo_contacto.id_persona,
    tr_mantic_persona_tipo_contacto.valor as celular
  from
    tr_mantic_persona_tipo_contacto
  where
    tr_mantic_persona_tipo_contacto.id_tipo_contacto in (6, 7, 8)
    and tr_mantic_persona_tipo_contacto.id_preferido= 1
  order by
    tr_mantic_persona_tipo_contacto.orden      
) as tt_mantic_persona_celular on tr_mantic_empresa_personal.id_persona= tt_mantic_persona_celular.id_persona
left join (
  select
    tr_mantic_persona_tipo_contacto.id_persona,
    tr_mantic_persona_tipo_contacto.valor as correo
  from
    tr_mantic_persona_tipo_contacto
  where
    tr_mantic_persona_tipo_contacto.id_tipo_contacto in (9, 10, 11)
    and tr_mantic_persona_tipo_contacto.id_preferido= 1
  order by
    tr_mantic_persona_tipo_contacto.orden      
) as tt_mantic_persona_correo on tr_mantic_empresa_personal.id_persona= tt_mantic_persona_correo.id_persona
inner join
  tc_mantic_personas on tr_mantic_empresa_personal.id_persona= tc_mantic_personas.id_persona
where
  tr_mantic_empresa_personal.id_empresa in ({sucursales})
  and tr_mantic_empresa_personal.id_activo= 1
  and tc_mantic_personas.id_tipo_persona!= 1
  and {condicion}
group by
  tr_mantic_empresa_personal.id_persona
order by
  tc_mantic_personas.nombres, 
  tc_mantic_personas.paterno,
  tc_mantic_personas.materno	
      </select>
      <select id="programados">
select      
  tc_kalan_citas.id_cita as id_key,
  tc_kalan_citas.id_cita,
  tc_kalan_citas.id_cita_estatus,
  tc_kalan_citas.consecutivo,
  tc_kalan_citas.inicio,
  tc_kalan_citas.termino,
  tc_kalan_citas.inicio as inicia,
  tc_mantic_clientes.id_cliente,
  if(tc_mantic_clientes.razon_social is null, ' ', concat(tc_mantic_clientes.razon_social, ' ', ifnull(tc_mantic_clientes.paterno, ''), ' ', ifnull(tc_mantic_clientes.materno, ''))) as cliente,
  group_concat(tc_mantic_articulos.nombre separator ', ') as servicios,
  tc_kalan_citas_estatus.nombre as estatus
from      
  tc_kalan_citas
inner join
  tr_mantic_empresa_personal on tc_kalan_citas.id_atendio= tr_mantic_empresa_personal.id_empresa_persona
inner join
  tc_kalan_citas_detalles on tc_kalan_citas.id_cita= tc_kalan_citas_detalles.id_cita
inner join
  tc_mantic_articulos on tc_kalan_citas_detalles.id_articulo= tc_mantic_articulos.id_articulo
left join
  tc_mantic_clientes on tc_kalan_citas.id_cliente= tc_mantic_clientes.id_cliente
left join
  tc_kalan_citas_estatus on tc_kalan_citas.id_cita_estatus= tc_kalan_citas_estatus.id_cita_estatus
where
  tr_mantic_empresa_personal.id_empresa_persona= {idEmpresaPersona}
group by
  tc_kalan_citas.id_cita
{sortOrder}        
      </select>  
  	  <select id="servicios">
select
  tc_mantic_articulos.id_articulo as id_key,
  tc_mantic_articulos.id_articulo,
  tc_mantic_articulos_codigos.codigo,
  tc_mantic_articulos.nombre,
  tc_mantic_articulos.precio      
from
  tc_mantic_articulos
inner join  
  tc_mantic_articulos_codigos on tc_mantic_articulos_codigos.id_articulo= tc_mantic_articulos.id_articulo and tc_mantic_articulos_codigos.id_principal= 1 and tc_mantic_articulos_codigos.id_proveedor is null
where  
  tc_mantic_articulos.id_articulo_tipo in ({idArticuloTipo})
  and {condicion}
{sortOrder}        
			</select>		
  	  <select id="detalle">
select
  tc_mantic_articulos.id_articulo as id_key,
  tc_mantic_articulos.id_articulo,
  tc_mantic_articulos_codigos.codigo,
  tc_mantic_articulos.nombre,
  tc_mantic_articulos.precio      
from
  tc_kalan_citas_detalles 
inner join  
  tc_mantic_articulos on tc_kalan_citas_detalles.id_articulo= tc_mantic_articulos.id_articulo
inner join  
  tc_mantic_articulos_codigos on tc_mantic_articulos_codigos.id_articulo= tc_mantic_articulos.id_articulo and tc_mantic_articulos_codigos.id_principal= 1 and tc_mantic_articulos_codigos.id_proveedor is null
where  
  tc_kalan_citas_detalles.id_cita= {idCita}
			</select>		
      <select id="paciente">
select
  tc_mantic_clientes.id_cliente as id_key,
  tc_mantic_clientes.*,
  concat(tc_mantic_clientes.razon_social, ' ', ifnull(tc_mantic_clientes.paterno, ''), ' ', ifnull(tc_mantic_clientes.materno, '')) as cliente,
  tt_mantic_cliente_celular.celular,
  tt_mantic_cliente_correo.correo,
  if(tc_kalan_citas.inicio is null, now(), tc_kalan_citas.inicio) as inicio,
  if(tc_kalan_citas.termino is null, now(), tc_kalan_citas.termino) as termino,
  if(tc_kalan_citas.recordatorio is null, 24, tc_kalan_citas.recordatorio) as recordatorio,
  if(tc_kalan_citas.notificacion is null, 2, tc_kalan_citas.notificacion) as notificacion,
  tc_kalan_citas.id_cita,
  tc_kalan_citas.consecutivo,
  ifnull(tc_kalan_citas.id_atendio, '-1') as id_atendio,
  ifnull(tc_kalan_citas.id_cita_estatus, '-1') as id_cita_estatus,
  tc_kalan_citas_estatus.nombre as estatus
from
  tc_mantic_clientes
left join
  tc_kalan_citas on tc_kalan_citas.id_cliente= tc_mantic_clientes.id_cliente and tc_kalan_citas.id_cita= {idCita}
left join (
  select
    tr_mantic_cliente_tipo_contacto.id_cliente,
    tr_mantic_cliente_tipo_contacto.valor as celular
  from
    tr_mantic_cliente_tipo_contacto
  where
    tr_mantic_cliente_tipo_contacto.id_cliente= {idCliente}
    and tr_mantic_cliente_tipo_contacto.id_tipo_contacto in (6, 7, 8)
    and tr_mantic_cliente_tipo_contacto.id_preferido= 1
  order by
    tr_mantic_cliente_tipo_contacto.orden      
  limit 1  
) as tt_mantic_cliente_celular on tc_mantic_clientes.id_cliente= tt_mantic_cliente_celular.id_cliente
left join (
  select
    tr_mantic_cliente_tipo_contacto.id_cliente,
    tr_mantic_cliente_tipo_contacto.valor as correo
  from
    tr_mantic_cliente_tipo_contacto
  where
    tr_mantic_cliente_tipo_contacto.id_cliente= {idCliente}
    and tr_mantic_cliente_tipo_contacto.id_tipo_contacto in (9, 10, 11)
    and tr_mantic_cliente_tipo_contacto.id_preferido= 1
  order by
    tr_mantic_cliente_tipo_contacto.orden      
  limit 1  
) as tt_mantic_cliente_correo on tc_mantic_clientes.id_cliente= tt_mantic_cliente_correo.id_cliente
left join
  tc_kalan_citas_estatus on tc_kalan_citas.id_cita_estatus= tc_kalan_citas_estatus.id_cita_estatus
where
  tc_mantic_clientes.id_cliente= {idCliente}
      </select>  
      <select id="notificar">
select
  tc_mantic_clientes.id_cliente as id_key,
  tc_mantic_clientes.*,
  concat(tc_mantic_clientes.razon_social, ' ', ifnull(tc_mantic_clientes.paterno, ''), ' ', ifnull(tc_mantic_clientes.materno, '')) as cliente,
  tt_mantic_cliente_celular.celular,
  tt_mantic_cliente_correo.correo,
  if(tc_kalan_citas.inicio is null, now(), tc_kalan_citas.inicio) as inicio,
  if(tc_kalan_citas.termino is null, now(), tc_kalan_citas.termino) as termino,
  if(tc_kalan_citas.recordatorio is null, 24, tc_kalan_citas.recordatorio) as recordatorio,
  if(tc_kalan_citas.notificacion is null, 2, tc_kalan_citas.notificacion) as notificacion,
  tc_kalan_citas.id_cita,
  tc_kalan_citas.consecutivo,
  ifnull(tc_kalan_citas.id_atendio, '-1') as id_atendio,
  ifnull(tc_kalan_citas.id_cita_estatus, '-1') as id_cita_estatus,
  tc_kalan_citas_estatus.nombre as estatus,
  ifnull(group_concat(tc_mantic_articulos.nombre separator ', '), '') as servicios
from
  tc_mantic_clientes
left join
  tc_kalan_citas on tc_kalan_citas.id_cliente= tc_mantic_clientes.id_cliente
left join (
  select
    tr_mantic_cliente_tipo_contacto.id_cliente,
    tr_mantic_cliente_tipo_contacto.valor as celular
  from
    tr_mantic_cliente_tipo_contacto
  where
    tr_mantic_cliente_tipo_contacto.id_tipo_contacto in (6, 7, 8)
    and tr_mantic_cliente_tipo_contacto.id_preferido= 1
  group by
    tr_mantic_cliente_tipo_contacto.id_cliente              
  order by
    tr_mantic_cliente_tipo_contacto.orden      
) as tt_mantic_cliente_celular on tc_mantic_clientes.id_cliente= tt_mantic_cliente_celular.id_cliente
left join (
  select
    tr_mantic_cliente_tipo_contacto.id_cliente,
    tr_mantic_cliente_tipo_contacto.valor as correo
  from
    tr_mantic_cliente_tipo_contacto
  where
    tr_mantic_cliente_tipo_contacto.id_tipo_contacto in (9, 10, 11)
    and tr_mantic_cliente_tipo_contacto.id_preferido= 1
  group by
    tr_mantic_cliente_tipo_contacto.id_cliente              
  order by
    tr_mantic_cliente_tipo_contacto.orden      
) as tt_mantic_cliente_correo on tc_mantic_clientes.id_cliente= tt_mantic_cliente_correo.id_cliente
left join
  tc_kalan_citas_detalles on tc_kalan_citas.id_cita= tc_kalan_citas_detalles.id_cita
left join
  tc_mantic_articulos on tc_kalan_citas_detalles.id_articulo= tc_mantic_articulos.id_articulo
left join
  tc_kalan_citas_estatus on tc_kalan_citas.id_cita_estatus= tc_kalan_citas_estatus.id_cita_estatus
where
  tc_mantic_clientes.id_empresa in ({sucursales})
  and tc_mantic_clientes.id_cliente!= 1
  and tt_mantic_cliente_celular.celular is not null
  and {condicion}
group by
  tc_mantic_clientes.id_cliente        
{sortOrder}        
      </select>  
      <select id="mensajes">
select
  tc_mantic_clientes.id_cliente as id_key,
  tc_mantic_clientes.*,
  concat(tc_mantic_clientes.razon_social, ' ', ifnull(tc_mantic_clientes.paterno, ''), ' ', ifnull(tc_mantic_clientes.materno, '')) as cliente,
  tc_kalan_mensajes_detalles.celular,
  tt_mantic_cliente_correo.correo,
  if(tc_kalan_citas.inicio is null, now(), tc_kalan_citas.inicio) as inicio,
  if(tc_kalan_citas.termino is null, now(), tc_kalan_citas.termino) as termino,
  if(tc_kalan_citas.recordatorio is null, 24, tc_kalan_citas.recordatorio) as recordatorio,
  if(tc_kalan_citas.notificacion is null, 2, tc_kalan_citas.notificacion) as notificacion,
  tc_kalan_citas.id_cita,
  tc_kalan_citas.consecutivo,
  ifnull(tc_kalan_citas.id_atendio, '-1') as id_atendio,
  ifnull(tc_kalan_citas.id_cita_estatus, '-1') as id_cita_estatus,
  tc_kalan_citas_estatus.nombre as estatus,
  ifnull(group_concat(tc_mantic_articulos.nombre separator ', '), '') as servicios
from
  tc_mantic_clientes
inner join        
  tc_kalan_mensajes_detalles on tc_kalan_mensajes_detalles.id_cliente= tc_mantic_clientes.id_cliente
inner join        
  tc_kalan_mensajes on tc_kalan_mensajes_detalles.id_mensaje= tc_kalan_mensajes.id_mensaje
left join
  tc_kalan_citas on tc_kalan_citas.id_cliente= tc_mantic_clientes.id_cliente
left join (
  select
    tr_mantic_cliente_tipo_contacto.id_cliente,
    tr_mantic_cliente_tipo_contacto.valor as correo
  from
    tr_mantic_cliente_tipo_contacto
  where
    tr_mantic_cliente_tipo_contacto.id_tipo_contacto in (9, 10, 11)
    and tr_mantic_cliente_tipo_contacto.id_preferido= 1
  group by
    tr_mantic_cliente_tipo_contacto.id_cliente              
  order by
    tr_mantic_cliente_tipo_contacto.orden      
) as tt_mantic_cliente_correo on tc_mantic_clientes.id_cliente= tt_mantic_cliente_correo.id_cliente
left join
  tc_kalan_citas_detalles on tc_kalan_citas.id_cita= tc_kalan_citas_detalles.id_cita
left join
  tc_mantic_articulos on tc_kalan_citas_detalles.id_articulo= tc_mantic_articulos.id_articulo
left join
  tc_kalan_citas_estatus on tc_kalan_citas.id_cita_estatus= tc_kalan_citas_estatus.id_cita_estatus
where
  tc_mantic_clientes.id_empresa in ({sucursales})
  and tc_mantic_clientes.id_cliente!= 1        
  and tc_kalan_mensajes.id_mensaje= {idMensaje}
group by
  tc_mantic_clientes.id_cliente        
{sortOrder}        
      </select>  
    </unit>    
	</dml>    
</process>
